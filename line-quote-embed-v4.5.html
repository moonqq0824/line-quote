<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ™¶å…¨è±ï½œç·šä¸Šè©¢åƒ¹ï¼ˆåµŒå…¥ç‰ˆ v4.5ï¼‰</title>
<style>
:root{--brand:#4A7C2D;--brand2:#7FB241;--text:#222;--muted:#777;--border:#ccc;--accent:#00c300;}
*{box-sizing:border-box}
body{margin:0;background:#fff;font-family:'Microsoft JhengHei','Noto Sans TC',system-ui,-apple-system,Arial,sans-serif;color:var(--text)}
.wrap{max-width:900px;margin:0 auto;padding:10px 8px 20px}
h2{margin:4px 0 6px;text-align:center;color:var(--brand);font-size:22px}
.progress{position:relative;height:8px;background:#eef2ee;border-radius:999px;overflow:hidden}
.progress i{position:absolute;inset:0;width:0;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .25s ease}
.steps{display:flex;justify-content:space-between;font-size:12px;color:#666;margin:6px 2px 10px}
.steps .on{color:#2c6;font-weight:700}
.percent{font-size:12px;text-align:right;color:#666;margin:-6px 2px 12px}
.sub{margin:0 0 12px;text-align:center;color:#666;font-size:14px}
.grid{display:flex;flex-wrap:wrap;gap:16px}
.col{flex:1 1 360px;position:relative}
input,select,textarea{width:100%;padding:12px;font-size:15px;border:1px solid var(--border);border-radius:8px;background:#fff}
textarea{min-height:100px;resize:vertical}
label{position:absolute;left:10px;top:10px;padding:0 6px;background:#fff;color:#888;font-size:14px;pointer-events:none;transition:all .18s}
.col input:focus+label,.col input:not(:placeholder-shown)+label,.col select:focus+label,.col select:not([value=""])+label,.col textarea:focus+label,.col textarea:not(:placeholder-shown)+label{top:-9px;left:8px;font-size:12px;color:var(--brand)}
.help{font-size:12px;color:#888;margin:6px 0 0 2px}
.err{display:none;font-size:12px;color:#d22;margin:6px 0 0 2px}
.tip{margin-top:10px;font-size:13px;color:#444;background:#f6f7f8;border:1px dashed #cfd4d8;padding:10px 12px;border-radius:8px}
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.btn{appearance:none;border:0;border-radius:10px;padding:12px 16px;font-size:16px;font-weight:700;cursor:pointer;transition:transform .05s;flex:1 1 220px}
.btn:active{transform:translateY(1px)}
.btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff}
.btn-secondary{background:var(--accent);color:#fff;text-decoration:none;text-align:center;line-height:22px;display:inline-block;border-radius:10px;font-weight:700}
.msg{display:none;margin-top:10px;color:var(--brand);font-weight:700;text-align:center}
.desktop{display:none;margin-top:12px;border:1px solid #e2e6ea;border-radius:8px;padding:12px;background:#fafbfc}
.desktop h3{margin:0 0 8px;font-size:16px;color:#222}
.desktop .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.desktop .link{padding:10px 12px;background:#fff;border:1px solid #cfd4d8;border-radius:8px;font-weight:700;text-decoration:none;color:#1a1a1a}
.desktop .box{width:100%;min-height:120px;padding:10px;border:1px dashed #cfd4d8;border-radius:8px;font-size:14px;white-space:pre-wrap;background:#fff}
.hint{font-size:12px;color:#666;margin-top:6px}
@media (max-width:560px){h2{font-size:20px}}
</style>
</head>
<body>
<div class="wrap" role="form" aria-label="æ™¶å…¨è± ç·šä¸Šè©¢åƒ¹ï¼ˆv4.5ï¼‰">
  <h2>æ™¶å…¨è±æœ‰é™å…¬å¸ ç·šä¸Šè©¢åƒ¹</h2>
  <div class="progress" aria-hidden="true"><i id="bar"></i></div>
  <div class="steps"><span id="st1" class="on">1 å¡«å¯«è¡¨å–®</span><span id="st2">2 è¤‡è£½å…§å®¹</span><span id="st3">3 ç”¨ LINE å‚³é€</span></div>
  <div class="percent" id="pct">å®Œæˆ 0%</div>
  <p class="sub">å¡«å¯«å®Œæˆå¾ŒæŒ‰ã€Œè¤‡è£½å…§å®¹ã€â†’ ã€Œç”¨ LINE å‚³é€åˆ°å®˜æ–¹å¸³è™Ÿã€å³å¯ã€‚</p>

  <div class="grid">
    <div class="col">
      <input id="company" placeholder=" " autocomplete="organization" required>
      <label for="company">å…¬å¸åç¨±ï¼ˆä¾‹ï¼šOOOOæœ‰é™å…¬å¸ï¼‰<span style="color:#d22">*</span></label>
      <div id="e-company" class="err">è«‹è¼¸å…¥å…¬å¸åç¨±</div>
    </div>
    <div class="col">
      <input id="contact" placeholder=" " autocomplete="name" required>
      <label for="contact">è¯çµ¡äºº<span style="color:#d22">*</span></label>
      <div id="e-contact" class="err">è«‹è¼¸å…¥è¯çµ¡äºº</div>
    </div>

    <div class="col">
      <input id="email" type="email" placeholder=" " inputmode="email" autocomplete="email" required>
      <label for="email">Email<span style="color:#d22">*</span></label>
      <div class="help">è«‹å¡«å¸¸ç”¨ä¿¡ç®±ï¼Œä¾¿æ–¼å¯„é€æ­£å¼å ±åƒ¹å–®</div>
      <div id="e-email" class="err">è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email</div>
    </div>
    <div class="col">
      <input id="mobile" type="tel" placeholder=" " inputmode="numeric" autocomplete="tel">
      <label for="mobile">æ‰‹æ©Ÿï¼ˆè‡ªå‹•åŠ  - ï¼‰</label>
      <div class="help">æ ¼å¼ï¼š0912-345-678</div>
      <div id="e-mobile" class="err">æ‰‹æ©Ÿéœ€ç‚º 09 é–‹é ­ 10 ç¢¼</div>
    </div>

    <div class="col">
      <input id="landline" type="tel" placeholder=" " autocomplete="tel">
      <label for="landline">å…¬å¸é›»è©±ï¼ˆè‡ªå‹•æ ¼å¼åŒ–ï¼‰</label>
      <div class="help">ä¾‹ï¼š02-1234-5678 æˆ– 037-123-456ï¼Œå¯åŠ  #åˆ†æ©Ÿ</div>
      <div id="e-landline" class="err">å¸‚è©±æ ¼å¼ä¸æ­£ç¢º</div>
    </div>
    <div class="col">
      <input id="ext" type="tel" placeholder=" " inputmode="numeric" autocomplete="off">
      <label for="ext">åˆ†æ©Ÿï¼ˆé¸å¡«ï¼‰</label>
      <div class="help">å¯è¼¸å…¥ 1â€“5 ç¢¼</div>
    </div>

    <div class="col">
      <select id="process" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="é›»è§£">é›»è§£</option>
        <optgroup label="é›»è‘—ï¼ˆæ³³ï¼‰">
          <option value="é›»è‘—ï¼ˆæ³³ï¼‰-å¹³é»‘">å¹³é»‘</option>
          <option value="é›»è‘—ï¼ˆæ³³ï¼‰-æ¶ˆå…‰é»‘">æ¶ˆå…‰é»‘</option>
          <option value="é›»è‘—ï¼ˆæ³³ï¼‰-å…¶ä»–ç‰¹æ®Šè‰²">å…¶ä»–ç‰¹æ®Šè‰²</option>
        </optgroup>
        <option value="é›»æ¼¿">é›»æ¼¿</option>
      </select>
      <label for="process">éœ€æ±‚å·¥è—<span style="color:#d22">*</span></label>
      <div id="e-process" class="err">è«‹é¸æ“‡éœ€æ±‚å·¥è—</div>
      <div id="proc-hint" class="hint"></div>
    </div>

    <div class="col">
      <input id="qty" type="number" placeholder=" " inputmode="numeric" min="1" step="1">
      <label for="qty">é è¨ˆè£½é€ æ•¸é‡</label>
    </div>
    <div class="col">
      <input id="material" placeholder=" " autocomplete="off" list="materials">
      <label for="material">æè³ªï¼ˆä¾‹ï¼šSUS304 / é‹åˆé‡‘ï¼‰</label>
      <datalist id="materials"><option value="SUS304"><option value="SUS316"><option value="é‹åˆé‡‘"><option value="é»ƒéŠ…"><option value="ç¢³é‹¼"></datalist>
    </div>
    <div class="col">
      <input id="surface" placeholder=" " autocomplete="off" list="surfaces">
      <label for="surface">å·¥è—éœ€æ±‚ï¼ˆä¾‹ï¼šå…‰æ»‘ / å»ç„Šç–¤ / æ¶ˆå…‰é»‘ï¼‰</label>
      <datalist id="surfaces"><option value="å…‰æ»‘"><option value="å»ç„Šç–¤"><option value="æ¶ˆå…‰é»‘"><option value="æ‹‹å…‰"><option value="å»æ¯›é‚Š"></datalist>
    </div>

    <div class="col" style="flex:1 1 100%;">
      <textarea id="note" placeholder=" "></textarea>
      <label for="note">å‚™è¨»</label>
    </div>
  </div>

  <div class="tip">
    <b>å»ºè­°ä¸€ä½µå‚³åœ–æª”</b>ï¼š3Dï¼ˆSolidWorks/STEPï¼‰æˆ–ç”¢å“ç…§ç‰‡ã€å°ºå¯¸æ¨™ç¤ºã€é¡è‰²/è¡¨é¢æ•ˆæœåƒè€ƒã€‚<br>
    åœ¨ LINE å‚³é€åœ–æª”ï¼Œå¯åŠ é€Ÿä¼°åƒ¹æ™‚ç¨‹èˆ‡ç²¾æº–åº¦ã€‚
  </div>

  <div class="actions">
    <button class="btn btn-primary" id="copyBtn" type="button">è¤‡è£½å ±åƒ¹å…§å®¹</button>
    <a class="btn btn-secondary" id="sendLineBtn" href="#" target="_blank" rel="noopener">ç”¨ LINE å‚³é€åˆ°å®˜æ–¹å¸³è™Ÿ</a>
  </div>
  <div class="msg" id="copiedMsg">å·²è¤‡è£½ï¼Œè«‹åœ¨ LINE å°è©±è¦–çª—è²¼ä¸Šä¸¦å‚³é€ã€‚</div>

  <div class="desktop" id="desk">
    <h3>åœ¨é›»è…¦ä¸Šç™¼é€æ–¹å¼</h3>
    <ol style="margin:0 0 10px 16px;padding:0">
      <li>è«‹å…ˆå®‰è£ä¸¦ç™»å…¥ <b>LINE é›»è…¦ç‰ˆ</b>ï¼ˆWindows / Macï¼‰ã€‚</li>
      <li>é»ã€Œé–‹å•Ÿ LINE é›»è…¦ç‰ˆã€ã€‚è‹¥ç„¡åæ‡‰ï¼Œè«‹å…ˆé»ã€ŒåŠ å¥½å‹ï¼ˆå¯é¡¯ç¤º QRï¼‰ã€ç”¨æ‰‹æ©Ÿæƒæã€‚</li>
    </ol>
    <div class="row">
      <a class="link" id="openApp" href="#">é–‹å•Ÿ LINE é›»è…¦ç‰ˆ</a>
      <a class="link" id="addFriend" href="https://line.me/R/ti/p/@482dwomb" target="_blank" rel="noopener">åŠ å¥½å‹ï¼ˆå¯é¡¯ç¤º QRï¼‰</a>
      <a class="link" href="https://line.me/download" target="_blank" rel="noopener">ä¸‹è¼‰ LINE é›»è…¦ç‰ˆ</a>
    </div>
    <div style="margin-top:10px;">è‹¥ä»ç„¡æ³•è‡ªå‹•è²¼ä¸Šï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š</div>
    <textarea id="deskMsg" class="box" readonly></textarea>
  </div>
</div>

<script>
(function(){
  const OA='@482dwomb';
  const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  const $=id=>document.getElementById(id);
  const els={
    company:$('company'),contact:$('contact'),email:$('email'),
    mobile:$('mobile'),landline:$('landline'),ext:$('ext'),
    process:$('process'),qty:$('qty'),material:$('material'),
    surface:$('surface'),note:$('note'),
    copyBtn:$('copyBtn'),sendLineBtn:$('sendLineBtn'),copiedMsg:$('copiedMsg'),
    desk:$('desk'),openApp:$('openApp'),deskMsg:$('deskMsg'),
    bar:$('bar'),pct:$('pct'),st1:$('st1'),st2:$('st2'),st3:$('st3'),
    e_company:$('e-company'),e_contact:$('e-contact'),e_email:$('e-email'),
    e_mobile:$('e-mobile'),e_landline:$('e-landline'),e_process:$('e-process'),
    procHint:$('proc-hint')
  };

  // ===== Mobile format (no trailing dashes) =====
  function fmtMobile(raw){
    const d=raw.replace(/\\D/g,'').slice(0,10);
    if(!d) return '';
    if(d.length<=4) return d;
    if(d.length<=7) return d.slice(0,4)+'-'+d.slice(4);
    return d.slice(0,4)+'-'+d.slice(4,7)+'-'+d.slice(7);
  }
  els.mobile.addEventListener('input', ()=>{
    const pos=els.mobile.selectionStart, before=els.mobile.value.length;
    els.mobile.value=fmtMobile(els.mobile.value);
    const after=els.mobile.value.length, off=after-before;
    try{els.mobile.setSelectionRange(Math.max(0,pos+off),Math.max(0,pos+off));}catch(e){}
    progress(); sendH();
  });

  // ===== Strict TW landline format =====
  // ordered area codes (longer first to match 0836 before 083)
  const AREA=['0836','082','089','049','037','02','03','04','05','06','07','08'];
  function detectArea(d){
    for(const a of AREA){ if(d.startsWith(a)) return a; }
    return null;
  }
  function fmtLandline(raw){
    // Allow '#ext' inline; we'll split but keep showing "#ext"
    const parts=raw.split('#'); const base=parts[0].replace(/\\D/g,'').replace(/^886/,'0').slice(0,11);
    const extPart=(parts[1]||'').replace(/\\D/g,'').slice(0,5);
    if(!base || base[0]!=='0') return (extPart?base+'#'+extPart:base);
    const area=detectArea(base);
    if(!area) return (extPart?base+'#'+extPart:base);
    const rest=base.slice(area.length);
    let out=area;
    // rules by area
    if(area==='02'){
      // 02 + 8 digits => 4-4; shorteræ™‚ç›¡é‡ 4|å‰©é¤˜
      if(rest.length<=4) out+='-'+rest;
      else out+='-'+rest.slice(0,4)+'-'+rest.slice(4,8);
    } else if(['03','04','05','06','07','08'].includes(area)){
      // 3|4 for full 7; else 3|å‰©é¤˜
      if(rest.length<=3) out+='-'+rest;
      else out+='-'+rest.slice(0,3)+'-'+rest.slice(3,7);
    } else if(['037','049','089','082'].includes(area)){
      // å¸¸è¦‹ 3|3 æˆ– 3|4 ä¾é•·åº¦
      if(rest.length<=3) out+='-'+rest;
      else if(rest.length<=6) out+='-'+rest.slice(0,3)+'-'+rest.slice(3,6);
      else out+='-'+rest.slice(0,3)+'-'+rest.slice(3,7);
    } else if(area==='0836'){
      // 0836 + 5ï¼ˆé¦¬ç¥–å¸¸è¦‹ 5 ä½ï¼‰â†’ 2|3ï¼›å…¶ä»–é•·åº¦ç›¡é‡åˆ‡ 2|å‰©é¤˜
      if(rest.length<=2) out+='-'+rest;
      else out+='-'+rest.slice(0,2)+'-'+rest.slice(2,5);
    } else {
      out+='-'+rest;
    }
    return out + (extPart?('#'+extPart):'');
  }
  els.landline.addEventListener('input', ()=>{
    const pos=els.landline.selectionStart, before=els.landline.value.length;
    els.landline.value=fmtLandline(els.landline.value);
    const after=els.landline.value.length, off=after-before;
    try{els.landline.setSelectionRange(Math.max(0,pos+off),Math.max(0,pos+off));}catch(e){}
    progress(); sendH();
  });
  els.ext.addEventListener('input', ()=>{
    els.ext.value=els.ext.value.replace(/\\D/g,'').slice(0,5);
  });

  // ===== Dynamic process hint =====
  const HINTS={
    'é›»è§£':'âš™ï¸ åƒ…é©ç”¨ 3 ç³»åˆ—ä¸é½é‹¼ï¼ˆSUS304 / SUS316ï¼‰ï¼Œå…¶ä»–æè³ªä¸é©ç”¨ã€‚',
    'é›»è‘—ï¼ˆæ³³ï¼‰-å¹³é»‘':'ğŸ¨ å¸¸è¦‹æ‡‰ç”¨ï¼šè€è•å¤–è§€ä»¶ï¼›è‹¥éœ€è‰²ç¥¨ï¼Œè«‹æä¾›è‰²æ¨£/è‰²ç¢¼ã€‚',
    'é›»è‘—ï¼ˆæ³³ï¼‰-æ¶ˆå…‰é»‘':'ğŸ¨ è¡¨é¢ä½åå…‰ï¼Œé©åˆå¤–è§€ä»¶ï¼›è«‹ä¸€ä½µæä¾›è¡¨é¢ç²—ç³™åº¦éœ€æ±‚ã€‚',
    'é›»è‘—ï¼ˆæ³³ï¼‰-å…¶ä»–ç‰¹æ®Šè‰²':'ğŸ¨ è«‹æä¾›è‰²ç¢¼/è‰²æ¨£ç…§ç‰‡ï¼Œä¾¿æ–¼è©•ä¼°å¯è¡Œæ€§ã€‚',
    'é›»æ¼¿':'âœ¨ é¡è‰²å¯èƒ½å› æè³ª/è¡¨é¢è™•ç†ç•¥æœ‰å·®ç•°ï¼Œå»ºè­°æä¾›æ¨£å“æˆ–åƒè€ƒåœ–ã€‚'
  };
  function updateHint(){
    const v=els.process.value; els.procHint.textContent=HINTS[v]||'';
    progress(); sendH();
  }
  els.process.addEventListener('change', updateHint);

  // ===== Validation =====
  function isEmail(v){ return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$/.test(v); }
  function isMobileOk(v){ const d=v.replace(/\\D/g,''); return d.length===10 && d.startsWith('09'); }
  function isLandlineOk(v){
    const parts=v.split('#'); const base=parts[0].replace(/\\D/g,'').replace(/^886/,'0');
    if(!base || base[0]!=='0') return false;
    const area=detectArea(base); if(!area) return false;
    const rest=base.slice(area.length);
    // basic length checks
    if(area==='02') return rest.length===8; // 02 + 8
    if(['03','04','05','06','07','08'].includes(area)) return rest.length===7;
    if(['037','049','089','082'].includes(area)) return (rest.length===6 || rest.length===7);
    if(area==='0836') return (rest.length===5);
    return false;
  }
  function show(el,ok){ el.style.display=ok?'none':'block'; }
  function validate(show=true){
    let ok=true;
    const a=els.company.value.trim(), b=els.contact.value.trim(), c=els.email.value.trim();
    const p=els.process.value;
    const hasM=els.mobile.value.trim().length>0, hasL=els.landline.value.trim().length>0;
    const moOk = hasM ? isMobileOk(els.mobile.value) : false;
    const llOk = hasL ? isLandlineOk(els.landline.value) : false;

    if(!a){ ok=false; if(show) show(els.e_company,false); } else show(els.e_company,true);
    if(!b){ ok=false; if(show) show(els.e_contact,false); } else show(els.e_contact,true);
    if(!isEmail(c)){ ok=false; if(show) show(els.e_email,false); } else show(els.e_email,true);
    if(!p){ ok=false; if(show) show(els.e_process,false); } else show(els.e_process,true);

    // è‡³å°‘ä¸€ç¨®é›»è©±
    if(!hasM && !hasL){ ok=false; if(show){ show(els.e_mobile,false); show(els.e_landline,false); } }
    else {
      if(hasM && !moOk){ ok=false; if(show) show(els.e_mobile,false); } else show(els.e_mobile,true);
      if(hasL && !llOk){ ok=false; if(show) show(els.e_landline,false); } else show(els.e_landline,true);
    }
    return ok;
  }

  // ===== Progress =====
  function progress(){
    const filled=[
      !!els.company.value.trim(), !!els.contact.value.trim(), isEmail(els.email.value.trim()), !!els.process.value,
      (isMobileOk(els.mobile.value) || isLandlineOk(els.landline.value))
    ];
    const done=filled.filter(Boolean).length, pct=Math.round(done/5*100);
    els.bar.style.width=pct+'%'; els.pct.textContent='å®Œæˆ '+pct+'%';
    if(pct<100){ els.st1.classList.add('on'); els.st2.classList.remove('on'); els.st3.classList.remove('on'); }
  }
  ['input','change','blur'].forEach(ev=>{
    ['company','contact','email','process','mobile','landline'].forEach(id=>{
      $(id).addEventListener(ev, ()=>{ validate(false); progress(); sendH(); });
    });
  });
  progress();

  // ===== Build message =====
  function build(){
    const parts=[
      'æ™¶å…¨è±è©¢åƒ¹éœ€æ±‚',
      'å…¬å¸åç¨±ï¼š'+els.company.value.trim(),
      'è¯çµ¡äººï¼š'+els.contact.value.trim(),
      'Emailï¼š'+els.email.value.trim()
    ];
    if(els.mobile.value.trim()) parts.push('æ‰‹æ©Ÿï¼š'+els.mobile.value.trim());
    let ll=els.landline.value.trim(), ex=els.ext.value.trim();
    if(ll||ex){ if(ll && ex && !/#\\d+$/.test(ll)) ll = ll + '#' + ex; parts.push('å…¬å¸é›»è©±ï¼š'+(ll || ('åˆ†æ©Ÿ '+ex))); }
    parts.push('éœ€æ±‚å·¥è—ï¼š'+(els.process.value||''));
    parts.push('é è¨ˆè£½é€ æ•¸é‡ï¼š'+(els.qty.value.trim()||''));
    parts.push('æè³ªï¼š'+(els.material.value.trim()||''));
    parts.push('å·¥è—éœ€æ±‚ï¼š'+(els.surface.value.trim()||''));
    parts.push('å‚™è¨»ï¼š'+(els.note.value.trim()||''));
    parts.push('ï¼ˆè«‹æ–¼ LINE ä¸€ä½µå‚³é€ 3D åœ–æª”æˆ–ç”¢å“ç…§ç‰‡ï¼ŒåŠ é€Ÿå ±åƒ¹ï¼‰');
    return parts.join('\\n');
  }
  function copyNative(t){ return navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(t) : Promise.reject(); }
  function copyFallback(t){ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); let ok=false; try{ ok=document.execCommand('copy'); }catch(e){ ok=false; } document.body.removeChild(ta); return ok?Promise.resolve():Promise.reject(); }
  function copyText(t){ return copyNative(t).catch(()=>copyFallback(t)); }

  els.copyBtn.addEventListener('click', ()=>{
    if(!validate(true)) return;
    copyText(build()).then(()=>{
      els.copiedMsg.style.display='block';
      els.copyBtn.textContent='å·²è¤‡è£½';
      els.st1.classList.remove('on'); els.st2.classList.add('on'); els.st3.classList.remove('on');
      setTimeout(()=>{ els.copyBtn.textContent='è¤‡è£½å ±åƒ¹å…§å®¹'; }, 1200);
      sendH();
    }).catch(()=>alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–å…§å®¹è¤‡è£½'));
  });

  els.sendLineBtn.addEventListener('click', (e)=>{
    if(!validate(true)){ e.preventDefault(); return; }
    const text=build();
    if(isMobile){
      const url='https://line.me/R/oaMessage/'+encodeURIComponent(OA)+'/?'+encodeURIComponent(text);
      els.sendLineBtn.setAttribute('href', url);
      els.st1.classList.remove('on'); els.st2.classList.add('on'); els.st3.classList.add('on');
    }else{
      e.preventDefault();
      const appUrl='line://oaMessage/'+encodeURIComponent(OA)+'/?'+encodeURIComponent(text);
      els.desk.style.display='block'; els.deskMsg.value=text; els.openApp.setAttribute('href', appUrl);
      window.location.href=appUrl;
      els.st1.classList.remove('on'); els.st2.classList.add('on'); els.st3.classList.add('on');
      sendH();
    }
  });

  // ===== Save draft (debounced) =====
  const KEY='cjf_quote_draft_v45';
  function save(){ const data={
    company:els.company.value,contact:els.contact.value,email:els.email.value,
    mobile:els.mobile.value,landline:els.landline.value,ext:els.ext.value,
    process:els.process.value,qty:els.qty.value,material:els.material.value,
    surface:els.surface.value,note:els.note.value
  }; try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){} }
  let t=null;
  function debouncedSave(){ clearTimeout(t); t=setTimeout(save, 250); }
  ['input','change'].forEach(ev=>document.addEventListener(ev, debouncedSave, true));
  // load when idle
  (window.requestIdleCallback||function(cb){setTimeout(cb,0)})(()=>{
    try{ const s=localStorage.getItem(KEY); if(!s) return;
      const d=JSON.parse(s)||{}; Object.keys(d).forEach(k=>{ if(els[k] && typeof d[k]==='string') els[k].value=d[k]; });
      updateHint(); progress(); sendH();
    }catch(e){}
  });

  // ===== Auto-height to parent =====
  function sendH(){ try{ const h=document.documentElement.scrollHeight||document.body.scrollHeight; window.parent.postMessage({type:'setHeight',height:h},'*'); }catch(e){} }
  ['load','resize'].forEach(ev=>window.addEventListener(ev, sendH));
  new MutationObserver(sendH).observe(document.body,{childList:true,subtree:true,attributes:true});
})();</script>
</body>
</html>
